name: CI/CD - Device Reservation Service

on:
  push:
    branches: [main, develop]
    paths:
      - 'Services/device-reservation/**'
      - '.github/workflows/reservation-cicd.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'Services/device-reservation/**'
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'
  WORKING_DIRECTORY: './Services/device-reservation'

# ======================================================
# ğŸ§ª TEST JOB
# ======================================================
jobs:
  test:
    name: Test & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci

      - name: ğŸ§ª Run all tests
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm test -- --ci --verbose

      - name: ğŸ“¤ Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reservation-test-results
          path: |
            ${{ env.WORKING_DIRECTORY }}/coverage
            ${{ env.WORKING_DIRECTORY }}/test-output.txt

  # ======================================================
  # ğŸ—ï¸ BUILD JOB
  # ======================================================
  build:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci

      - name: ğŸ—ï¸ Build
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm run build

      - name: ğŸ“¦ Package deployment bundle
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp package.json package-lock.json host.json deploy/
          cd deploy && npm ci --omit=dev

      - name: ğŸ“¤ Upload build bundle
        uses: actions/upload-artifact@v4
        with:
          name: reservation-build
          path: ${{ env.WORKING_DIRECTORY }}/deploy

  # ======================================================
  # ğŸš€ DEPLOY DEV (develop branch)
  # ======================================================
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: dev
      url: https://devicereservation-dev-ab07-func.azurewebsites.net

    steps:
      - name: ğŸ“¥ Download build
        uses: actions/download-artifact@v4
        with:
          name: reservation-build
          path: ./deploy

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      - name: ğŸ“¦ Create ZIP
        run: cd deploy && zip -r ../deploy.zip .

      - name: ğŸš€ Deploy ZIP to DEV Linux Function
        run: |
          az functionapp deployment source config-zip \
            -g CampusDeviceLender-dev-Ab07-rg \
            -n devicereservation-dev-ab07-func \
            --src deploy.zip

      - name: ğŸ” Health Check
        run: |
          sleep 20
          curl -f https://devicereservation-dev-ab07-func.azurewebsites.net/api/health || echo "âŒ Dev health check failed"

  # ======================================================
  # ğŸš€ DEPLOY TEST (main branch)
  # ======================================================
  deploy-test:
    name: Deploy to TEST
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: test
      url: https://devicereservation-test-ab07-func.azurewebsites.net

    steps:
      - name: ğŸ“¥ Download build
        uses: actions/download-artifact@v4
        with:
          name: reservation-build
          path: ./deploy

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_TEST }}

      - name: ğŸ“¦ Create ZIP
        run: cd deploy && zip -r ../deploy.zip .

      - name: ğŸš€ Deploy to TEST Function
        run: |
          az functionapp deployment source config-zip \
            -g CampusDeviceLender-test-Ab07-rg \
            -n devicereservation-test-ab07-func \
            --src deploy.zip

      - name: ğŸ” Test Health Check
        run: |
          sleep 20
          curl -f https://devicereservation-test-ab07-func.azurewebsites.net/api/health || echo "âŒ Test health check failed"

  # ======================================================
  # ğŸš€ DEPLOY PROD (manual approval in GitHub UI)
  # ======================================================
  deploy-prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: deploy-test
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: production
      url: https://devicereservation-prod-ab07-func.azurewebsites.net

    steps:
      - name: ğŸ“¥ Download build
        uses: actions/download-artifact@v4
        with:
          name: reservation-build
          path: ./deploy

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: ğŸ“¦ Create ZIP
        run: cd deploy && zip -r ../deploy.zip .

      - name: ğŸš€ Deploy to PROD
        run: |
          az functionapp deployment source config-zip \
            -g CampusDeviceLender-prod-Ab07-rg \
            -n devicereservation-prod-ab07-func \
            --src deploy.zip

      - name: ğŸ” Prod Health Check
        run: |
          sleep 30
          curl -f https://devicereservation-prod-ab07-func.azurewebsites.net/api/health || echo "âŒ Prod health check failed"
